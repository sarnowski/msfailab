# Linux Production: Build from source with host network mode
#
# Usage:
#   docker compose -f compose.linux.prod.yaml up --build -d
#
# Configuration: Copy .env.example to .env and configure at minimum one AI backend.
# See DEPLOYMENT.md for full details.

services:
  postgres:
    image: postgres:17
    container_name: msfailab-postgres
    network_mode: host
    # Bind to localhost only - not exposed to network
    command: postgres -c listen_addresses=localhost
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: msfailab
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -h localhost"]
      interval: 5s
      timeout: 5s
      retries: 5

  msfconsole-image:
    build: ./msfconsole
    image: msfailab-msfconsole
    command: ["true"]
    network_mode: host

  migrate:
    build: .
    image: msfailab-server
    network_mode: host
    command: /app/bin/migrate
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: ecto://postgres:postgres@localhost/msfailab
      # SECURITY: Change for non-demo deployments! Generate with: openssl rand -base64 48
      MSFAILAB_SECRET_KEY_BASE: ${MSFAILAB_SECRET_KEY_BASE:-insecure-demo-secret-change-me-in-production-generate-with-openssl}

  server:
    image: msfailab-server
    network_mode: host
    depends_on:
      postgres:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      msfconsole-image:
        condition: service_completed_successfully
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DATABASE_URL: ecto://postgres:postgres@localhost/msfailab
      # SECURITY: Change for non-demo deployments! Generate with: openssl rand -base64 48
      MSFAILAB_SECRET_KEY_BASE: ${MSFAILAB_SECRET_KEY_BASE:-insecure-demo-secret-change-me-in-production-generate-with-openssl}
      # Web UI binding (default: localhost only)
      MSFAILAB_PORT: ${MSFAILAB_PORT:-4000}
      MSFAILAB_HOST: ${MSFAILAB_HOST:-localhost}
      # Docker configuration
      MSFAILAB_DOCKER_ENDPOINT: /var/run/docker.sock
      MSFAILAB_DOCKER_NETWORK: host
      MSFAILAB_DEFAULT_CONSOLE_IMAGE: ${MSFAILAB_DEFAULT_CONSOLE_IMAGE:-msfailab-msfconsole}
      # Database URL for MSF containers (on host network, use localhost)
      MSF_DB_URL: postgres://postgres:postgres@localhost:5432/msfailab
      # AI backend configuration (at least one required)
      MSFAILAB_OLLAMA_HOST: ${MSFAILAB_OLLAMA_HOST:-}
      MSFAILAB_OLLAMA_MODEL_FILTER: ${MSFAILAB_OLLAMA_MODEL_FILTER:-}
      MSFAILAB_OLLAMA_THINKING: ${MSFAILAB_OLLAMA_THINKING:-}
      MSFAILAB_OPENAI_API_KEY: ${MSFAILAB_OPENAI_API_KEY:-}
      MSFAILAB_OPENAI_MODEL_FILTER: ${MSFAILAB_OPENAI_MODEL_FILTER:-}
      MSFAILAB_ANTHROPIC_API_KEY: ${MSFAILAB_ANTHROPIC_API_KEY:-}
      MSFAILAB_ANTHROPIC_MODEL_FILTER: ${MSFAILAB_ANTHROPIC_MODEL_FILTER:-}
      MSFAILAB_DEFAULT_MODEL: ${MSFAILAB_DEFAULT_MODEL:-}
      # Logging configuration
      MSFAILAB_LOG_LEVEL: ${MSFAILAB_LOG_LEVEL:-}

volumes:
  postgres_data:
